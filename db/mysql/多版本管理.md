InnoDB是一个多版本存储引擎。它保存已经更改行的旧版本信息，以支持并发和回滚等事务功能。这些信息存储在被叫做回滚字段的数据结构中的撤销（undo）表空间。InnoDB使用回滚段中的信息来执行事务回滚中所需要的撤销操作。InnoDB还使用这些信息为一致读建立记录的早期版本。

在内部，InnoDB向存储在数据库中的每一行添加三个字段：

- DB_TRX_ID（6B）：存储插入或修改的最后一个事务的标识。
- DB_ROLL_PTR（7B）：被称为回滚指针，它指向写入回滚段的撤销日志记录。如果记录被更新，则撤销日志记录包含重建更新前记录内容所需要的信息。
- DB_ROW_ID（6B）：包含一个行ID，随着新行插入，该行ID会单调递增。如果InnoDB直到生成聚合索引，该索引就会包含此ID，否则此ID不会出现在任何索引中。

回滚段中的撤销日志分为插入撤销日志和更新撤销日志。插入撤销日志只在事务回滚中使用，事务提交后即可丢弃。更新撤销日志在一致读中也会使用，但它在目前不存在InnoDB已经为其分配快照的事务时能被删除。

在InnoDB多版本方案中，使用SQL删除时，不会立即物理删除。InnoDB只有在丢弃为删除而写入的更新撤销日志时，才会物理删除相应行和索引。这种操作被称为清除（purge），速度非常快。





# 多版本和二级索引

InnoDB MVCC处理主键索引和二级索引的方式不同。主键索引中的记录是直接更新的，并且其隐藏字段指向撤销日志，可以从日志中构建早期版本。二级索引不包含隐藏字段，也就不会直接更新。

更新二级索引时，旧的记录将被标记为删除，新记录会被插入，标记记录最终会被清除。当记录被标记为删除或被其他事务更新时，InnoDB将回表，并检查记录的回滚日志。如果记录是在读事务开始之后修改的，则InnoDB会将其恢复到正确的版本。

如果二级索引记录被标记为删除或被其他事务更新时，则InnoDB不使用【覆盖技术】。InnoDB将从主键索引返回结果而非二级索引。

如果启用了索引条件下推 (ICP) 优化，并且部分条件可以使用索引字段评估，则MySQL会将这部分条件下推到存储引擎，并在存储引擎中使用索引进行评估。如果没有匹配记录，就能避免回表，如果存在匹配记录，即时被标记为删除，也需要回表。

